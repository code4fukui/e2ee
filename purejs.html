<!DOCTYPE html><html lang="ja">
  <head><meta charset="utf-8"><meta name="viewport" content="width=device-width">
    <title>E2EEメッセージングヘルパー - Pure JavaScript ver.</title>
    <script type="module">
    import { ECDH } from "https://taisukef.github.io/ECDH-es/ECDH.js";
    import { hex } from "https://code4sabae.github.io/js/hex.js";
    import { Buffer } from "https://taisukef.github.io/buffer/Buffer.js";
    import { AESGCM } from "https://taisukef.github.io/AES-GCM-es/AESGCM.js";

    window.onload = () => {
      const type = "secp256r1";
      const curve = ECDH.getCurve(type);
      let iv = null;

      generatebutton.onclick = async () => {
        const keypair = ECDH.generateKeys(curve);
        ecdhpublickey.value = keypair.publicKey.buffer.toString("hex");
        ecdhprivatekey.value = keypair.privateKey.buffer.toString("hex");
      };
      generatebutton2.onclick = async () => {
      	const privateKey = ECDH.PrivateKey.fromBuffer(curve, Buffer.from(ecdhprivatekey.value, "hex"));
        const peerPublicKey = ECDH.PublicKey.fromBuffer(curve, Buffer.from(ecdhpublickey2.value, "hex"));
        const secretKey = privateKey.deriveSharedSecret(peerPublicKey);
        ecdhsecretkey.value = hex.fromBin(secretKey);
        iv = AESGCM.createIV();
      };
      encryptbutton.onclick = async () => {
        const data = new TextEncoder().encode(ecdhmessage.value);
        const key = hex.toBin(ecdhsecretkey.value);
        AESGCM.incrementIV(iv);
        const [encdata, tag] = AESGCM.encrypt(key, iv, data);
        ecdhciphertext.value = hex.fromBin(iv) + "_" + hex.fromBin(encdata) + "_" + hex.fromBin(tag);
      };
      decryptbutton.onclick = async () => {
        const key = hex.toBin(ecdhsecretkey.value);
        const [iv, encdata, tag] = ecdhciphertext.value.split("_").map(h => hex.toBin(h));
        const data = AESGCM.decrypt(key, iv, encdata, tag);
        if (data) {
          ecdhmessage.value = new TextDecoder().decode(data);
        } else {
          ecdhmessage.value = "復号失敗";
        }
      };
    };
    </script>
    <style>
    body {
      font-family: sans-serif;
    }
    input[type="text"] {
      width: 80vw;
    }
    .message {
      width: 30vw;
      height: 5em;
    }
    .description {
      font-size: 85%;
    }
    </style>
  </head>
  <body>
    <main>
      <h1>E2EEメッセージングヘルパー - Pure JavaScript ver.</h1>
        <section>
          <div class=description>
            既存の信用できない通信路を使った信用できる通信を実現する補助ツールです。<br>
            ECDHによるキーペアの生成と受け取った公開鍵から共通鍵の生成をし、AES-256-GCMで暗号化復号化します。<br>
            本ページの読み込み後、サーバーとの通信はしません。<a href=https://github.com/code4sabae/e2ee/>ソースファイル</a>でご確認ください。
          </div>
          <br>
          <input id="generatebutton" type="button" value="1. キーペア（公開鍵と秘密鍵）をつくる"><br>
          <br>
          秘密鍵（誰にも見せてはいけない鍵）<br>
          <input type="text" id="ecdhprivatekey"><br>
          公開鍵（相手に渡す鍵、公開してもOK！）<br>
          <input type="text" id="ecdhpublickey"><br>
          <br>
          2. 相手の公開鍵（通信する相手から公開鍵をもらって、書く）<br>
          <input type="text" id="ecdhpublickey2"><br>
          <br>
          <input id="generatebutton2" type="button" value="3. 通信用の共通鍵をつくる"><br>
          <br>
          共通鍵（ネットワークには流れていないけど、通信相手と同じ鍵）<br>
          <input type="text" id="ecdhsecretkey"><br>
          <br>
          <hr>
          <table>
            <tr><th>メッセージ</th><th></th><th>暗号</th></tr>
            <tr>
              <td><textarea class="message" id="ecdhmessage"></textarea></td>
              <td>
                <input id="encryptbutton" type="button" value="暗号化→"><br>
                <br>
                <input id="decryptbutton" type="button" value="←復号化"><br>
              </td>
              <td><textarea class="message" id="ecdhciphertext"></textarea></td>
            </tr>
          </table>
          <br>
        </section>
        <hr>
        <div id="credit">
          App: CC BY <a href=https://fukuno.jig.jp/3308>福野泰介の一日一創</a><br>
          API: <a href=https://github.com/taisukef/ECDH-es>ECDH-es</a>, <a href=https://github.com/taisukef/AES-GCM-es>AES-GCM-es</a> - Pure JavaScript ES module<br>
        </div>
    </main>
  </body>
</html>
